# pinentry-tty-wrapper 機能仕様書

## 概要

gpg-agent forwarding を行っている環境で ssh 接続先で秘密鍵のパスフレーズ入力の為にgpg-agentから起動される pinentry-tty が termios の設定により正しく入出力できない場合がある。
それを回避するための pinentry-tty の wrapper である。

## 背景
ssh terminal negosiation が行われると、
接続元の terminal の termios から ICRNL と OPOST が落とされてしまう場合がある。

- ICRNL: 入力時に CR を LF に変換する。
- OPOST: 出力時に設定された変換などの処理を行う。

ssh で接続したということは端末が local と remote の二つになるため、
どちらかは ICRNL と OPOST を落とさなければならない。
通常 local 側が落とされるので、
すると次のような現象が起きてしまう。

- ICRNL: 入力時にCRをLFに変換しないため、リターンキーを押下しても入力終了とならない。^J で終了出来る。
- OPOST: 改行を出力する際にCRが出力されないためカーソルは1行下に移動するだけで行頭に移動しない。

そのため、pinentry-tty を呼び出すラッパープログラムを作り、
必要な termios の設定を行ってから pinentry-tty を呼び出すようにする。

## pinentry-tty-wrapper機能仕様

### 実行方法

```
pinentry-tty-wrapper <pinentry-tty-program> [<pinentry-tty-arguments>, ...]
```
- pinentry-tty-program: 実行する pinentry-tty プログラムのパス。起動出来るのであればフルパスでも相対パスでも可能。
- pinentry-tty-arguments: pinentry-tty に渡すコマンドライン引数。

### 前提条件

- 本プログラムは GPG_TTY 環境変数が定義されていることを前提とする。
- GPG_TTY が未定義の場合、エラーメッセージを表示して終了する。

### 正常系処理

- termios を保存する。
- termios に以下の変更を行う。
 - ICRNL を立てる。
 - OPOST を立てる。
- 引数で渡された <pinentry-tty-program> を <pinentry-tty-arguments> を付けて実行する。
- <pinentry-tty-program> の終了を待つ。
- termios を保存した値に戻す。
- <pinentry-tty-program> の終了コードで終了する。

### 異常系処理

以下の場合、エラーメッセージを標準エラー出力に出力し、終了コード 1 で終了する。

- コマンドライン引数が不足している場合
  - 使用方法を表示する。
- システムコールが失敗した場合
  - エラーメッセージを表示する。
- GPG_TTY 環境変数が未定義の場合
  - 「GPG_TTY が未定義である」旨のエラーメッセージを表示し、終了する。

子プロセスがシグナルにより終了した場合も、終了コード 1 で終了する。